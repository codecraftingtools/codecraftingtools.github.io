<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RTEMS &mdash; Code Craftsmen  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Git" href="git-notes.html" />
    <link rel="prev" title="Xenomai" href="xenomai-notes.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Code Craftsmen
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="vision.html">Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflow/workflow.html">Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="status.html">Status</a></li>
<li class="toctree-l1"><a class="reference internal" href="philosophy.html">Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="guidelines.html">Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="considerations.html">Considerations</a></li>
<li class="toctree-l1"><a class="reference internal" href="software.html">Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="foundation.html">Foundation</a></li>
<li class="toctree-l1"><a class="reference internal" href="conventions.html">Conventions</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="notes.html">Notes</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="sphinx-notes.html">Sphinx</a></li>
<li class="toctree-l2"><a class="reference internal" href="lark-notes.html">Lark</a></li>
<li class="toctree-l2"><a class="reference internal" href="libavoid-notes.html">libavoid</a></li>
<li class="toctree-l2"><a class="reference internal" href="qt-notes.html">Qt 5</a></li>
<li class="toctree-l2"><a class="reference internal" href="virtualenvwrapper-notes.html">virtualenvwrapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="python-notes.html">Python 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="ubuntu-notes.html">Ubuntu</a></li>
<li class="toctree-l2"><a class="reference internal" href="xenomai-notes.html">Xenomai</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">RTEMS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#external-documentation">External Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#installation-notes-ubuntu-18-04">Installation Notes (Ubuntu 18.04)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#build-the-rsb-tools">Build the RSB Tools</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-the-desired-rtems-bsps">Build the Desired RTEMS BSPs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compile-a-hello-world-application">Compile a Hello World Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-the-bootgen-tool-zynq-zynqmp-targets">Build the bootgen tool (Zynq/ZynqMP Targets)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-the-arm-trusted-firmware-for-zynqmp-targets">Building the ARM Trusted Firmware for ZynqMP Targets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-the-pmu-firmware-for-zynqmp">Building the PMU Firmware for ZynqMP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-a-boot-image-for-zynq-targets">Build a Boot Image for Zynq Targets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-a-boot-image-for-zynqmp-targets">Build a Boot Image for ZynqMP Targets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#raspberry-pi-setup">Raspberry Pi Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-a-raspberry-pi-kernel-image">Building a Raspberry Pi Kernel Image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#booting-a-raspberry-pi-kernel-image">Booting a Raspberry Pi Kernel Image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#booting-a-qemu-image">Booting a QEMU Image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#booting-a-microzed-boot-bin-image">Booting a MicroZed BOOT.BIN Image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#booting-an-ultrazed-boot-bin-image">Booting an UltraZed BOOT.BIN Image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-libbsd-for-rtems-optional">Build libbsd for RTEMS (Optional)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#an-application-to-test-libbsd">An Application to Test libbsd</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tools-for-examining-executables">Tools for Examining Executables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-u-boot-optional">Building U-Boot (Optional)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#basic-u-boot-configuration-for-the-microzed-optional">Basic U-Boot Configuration for the MicroZed (Optional)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#basic-u-boot-configuration-for-the-ultrazed-optional">Basic U-Boot Configuration for the UltraZed (Optional)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tftp-boot-on-the-microzed-optional">TFTP Boot on the MicroZed (Optional)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tftp-boot-on-the-ultrazed-optional">TFTP Boot on the UltraZed (Optional)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#alternative-u-boot-boot-commands">Alternative U-Boot Boot Commands</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-a-remote-debugger-with-the-microzed-ultrazed">Using a Remote Debugger with the MicroZed/UltraZed</a></li>
<li class="toctree-l4"><a class="reference internal" href="#debugging-a-qemu-image">Debugging a QEMU Image</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="git-notes.html">Git</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contact.html">Contact</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Code Craftsmen</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="notes.html">Notes</a></li>
      <li class="breadcrumb-item active">RTEMS</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/rtems-notes.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="rtems">
<h1>RTEMS<a class="headerlink" href="#rtems" title="Permalink to this heading"></a></h1>
<p><a class="reference internal" href="foundation.html#rtems"><span class="std std-ref">RTEMS</span></a> is an embedded, open-source, real-time operating system.</p>
<section id="external-documentation">
<h2>External Documentation<a class="headerlink" href="#external-documentation" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://www.rtems.org">RTEMS Web Site</a></p></li>
<li><p><a class="reference external" href="https://docs.rtems.org/branches/master/user/bsps/arm/raspberrypi.html">RTEMS Raspberry Pi Info</a></p></li>
<li><p><a class="reference external" href="https://docs.adacore.com/gnat_ugx-docs/html/gnat_ugx/gnat_ugx/rtems_topics.html">RTEMS Debugging Example</a></p></li>
<li><p><a class="reference external" href="https://lists.rtems.org/pipermail/users/2020-April/067600.html">More RTEMS Debugging Info</a></p></li>
</ul>
</section>
<section id="installation-notes-ubuntu-18-04">
<h2>Installation Notes (Ubuntu 18.04)<a class="headerlink" href="#installation-notes-ubuntu-18-04" title="Permalink to this heading"></a></h2>
<section id="build-the-rsb-tools">
<h3>Build the RSB Tools<a class="headerlink" href="#build-the-rsb-tools" title="Permalink to this heading"></a></h3>
<p>The first step is to build a suitable cross-compiler toolchain for the target
CPU architectures.  This is done using the <code class="docutils literal notranslate"><span class="pre">rtems-source-builder</span></code> tool.</p>
<p>First, install the system packages required to build the cross compiler:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">build</span><span class="o">-</span><span class="n">essential</span> <span class="n">g</span><span class="o">++</span> <span class="n">gdb</span> <span class="n">git</span> <span class="n">unzip</span> <span class="n">pax</span> <span class="n">bison</span> <span class="n">flex</span> <span class="n">libpython</span><span class="o">-</span><span class="n">dev</span> <span class="n">libncurses5</span><span class="o">-</span><span class="n">dev</span> <span class="n">zlib1g</span><span class="o">-</span><span class="n">dev</span>
</pre></div>
</div>
<p>Now pull down the Python-based <code class="docutils literal notranslate"><span class="pre">rtems-source-builder</span></code> project and
(optionally) check out the specific revision that was used when writing these
notes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">git</span><span class="p">:</span><span class="o">//</span><span class="n">git</span><span class="o">.</span><span class="n">rtems</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">rtems</span><span class="o">-</span><span class="n">source</span><span class="o">-</span><span class="n">builder</span><span class="o">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">rtems</span><span class="o">-</span><span class="n">source</span><span class="o">-</span><span class="n">builder</span><span class="o">/</span><span class="n">rtems</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="n">f0e34ea</span>
</pre></div>
</div>
<p>These are some optional, but useful commands you can run at this point:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">../</span><span class="n">source</span><span class="o">-</span><span class="n">builder</span><span class="o">/</span><span class="n">sb</span><span class="o">-</span><span class="n">check</span>
<span class="o">../</span><span class="n">source</span><span class="o">-</span><span class="n">builder</span><span class="o">/</span><span class="n">sb</span><span class="o">-</span><span class="nb">set</span><span class="o">-</span><span class="n">builder</span> <span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">bsets</span>
</pre></div>
</div>
<p>Then build the 32-bit ARM toolchain:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ DOCBOOK_TO_MAN=&quot;xmlto man --skip-validation&quot; \
  ../source-builder/sb-set-builder --without-rtems \
  --prefix=/opt/rsb-tools-rtems-6-f0e34ea 6/rtems-arm
</pre></div>
</div>
<p>and/or the 64-bit ARM toolchain:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ DOCBOOK_TO_MAN=&quot;xmlto man --skip-validation&quot; \
  ../source-builder/sb-set-builder --without-rtems \
  --prefix=/opt/rsb-tools-rtems-6-f0e34ea 6/rtems-aarch64
</pre></div>
</div>
</section>
<section id="build-the-desired-rtems-bsps">
<h3>Build the Desired RTEMS BSPs<a class="headerlink" href="#build-the-desired-rtems-bsps" title="Permalink to this heading"></a></h3>
<p>First, pull down the <code class="docutils literal notranslate"><span class="pre">rtems</span></code> source repository and (optionally) check out
the specific revision that was used when writing these notes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">git</span><span class="p">:</span><span class="o">//</span><span class="n">git</span><span class="o">.</span><span class="n">rtems</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">rtems</span><span class="o">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">rtems</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="n">acf4eb2</span>
</pre></div>
</div>
<p>Now make sure that the <code class="docutils literal notranslate"><span class="pre">rtems-source-builder</span></code> tools are in your path:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">PATH</span><span class="o">=</span><span class="s2">&quot;/opt/rsb-tools-rtems-6-f0e34ea/bin:$PATH&quot;</span>
</pre></div>
</div>
<p>These are some optional, but useful commands you can run at this point:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">waf</span> <span class="n">bsplist</span>
<span class="o">./</span><span class="n">waf</span> <span class="n">bsplist</span> <span class="o">--</span><span class="n">rtems</span><span class="o">-</span><span class="n">bsps</span><span class="o">=</span><span class="s1">&#39;arm/.*zynq.*&#39;</span>
<span class="o">./</span><span class="n">waf</span> <span class="n">bsplist</span> <span class="o">--</span><span class="n">rtems</span><span class="o">-</span><span class="n">bsps</span><span class="o">=</span><span class="s1">&#39;aarch64/xilinx_zynqmp.*&#39;</span>
<span class="o">./</span><span class="n">waf</span> <span class="n">bspdefaults</span> <span class="o">--</span><span class="n">rtems</span><span class="o">-</span><span class="n">bsps</span><span class="o">=</span><span class="s1">&#39;aarch64/xilinx_zynqmp_lp64_zu3eg&#39;</span>
</pre></div>
</div>
<p>Now create a sample configuration file for the BSP to build.  The following
is suitable for use with an UltraZed board:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;[aarch64/xilinx_zynqmp_lp64_zu3eg]&quot;</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;BUILD_SAMPLES = False&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;RTEMS_POSIX_API = True&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;BSP_RESET_BOARD_AT_EXIT = 0&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
<p>The following is suitable for use with a MicroZed or ZedBoard:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;[arm/xilinx_zynq_zedboard]&quot;</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;BUILD_SAMPLES = False&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;RTEMS_POSIX_API = True&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;BSP_RESET_BOARD_AT_EXIT = 0&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;BSP_ARM_A9MPCORE_PERIPHCLK = 333333333&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;ZYNQ_RAM_LENGTH = 0x40000000&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
<p>The following is suitable for use with a Zynq7000 QEMU setup:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;[arm/xilinx_zynq_a9_qemu]&quot;</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;BUILD_SAMPLES = False&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;RTEMS_POSIX_API = True&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;BSP_RESET_BOARD_AT_EXIT = 0&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
<p>The following is suitable for use with a ZynqMP QEMU setup:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;[aarch64/xilinx_zynqmp_lp64_qemu]&quot;</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;BUILD_SAMPLES = False&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;RTEMS_POSIX_API = True&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;BSP_RESET_BOARD_AT_EXIT = 0&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
<p>The following is suitable for use with a Raspberry Pi:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;[arm/raspberrypi]&quot;</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;BUILD_SAMPLES = False&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;RTEMS_POSIX_API = True&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;BSP_RESET_BOARD_AT_EXIT = 0&quot;</span> <span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
<p>Once you have a config file, you can build an RTEMS BSP like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">waf</span> <span class="n">configure</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span>
<span class="o">./</span><span class="n">waf</span>
<span class="o">./</span><span class="n">waf</span> <span class="n">install</span>
</pre></div>
</div>
<p>Note that appropriate compiler/linker flags for each BPS can be found in the
associated <code class="docutils literal notranslate"><span class="pre">.pc</span></code> files found here:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pkgconfig</span><span class="o">/</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>With the appropriate options, the RTEMS BSPs can alternatively be built from
an “out-of-tree” build directory.  e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/path/to/rtems/waf --out=$PWD/build --top=/path/to/rtems --no-lock-in-top --no-lock-in-run --prefix=/opt/rsb-tools-rtems-6-f0e34ea configure --rtems-config $PWD/config.ini

/path/to/rtems/waf --out=$PWD/build --top=/path/to/rtems --no-lock-in-top --no-lock-in-run --prefix=/opt/rsb-tools-rtems-6-f0e34ea

/path/to/rtems/waf --out=$PWD/build --top=/path/to/rtems --no-lock-in-top --no-lock-in-run --prefix=/opt/rsb-tools-rtems-6-f0e34ea install
</pre></div>
</div>
</div>
</section>
<section id="compile-a-hello-world-application">
<h3>Compile a Hello World Application<a class="headerlink" href="#compile-a-hello-world-application" title="Permalink to this heading"></a></h3>
<p>Create a file called <code class="docutils literal notranslate"><span class="pre">hello.c</span></code> containing:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">POSIX_Init</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Hello World&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CONFIGURE_APPLICATION_NEEDS_CONSOLE_DRIVER</span>
<span class="cp">#define CONFIGURE_APPLICATION_NEEDS_CLOCK_DRIVER</span>
<span class="cp">#define CONFIGURE_POSIX_INIT_THREAD_TABLE</span>
<span class="cp">#define CONFIGURE_INIT</span>
<span class="cp">#define CONFIGURE_UNLIMITED_OBJECTS</span>
<span class="cp">#define CONFIGURE_UNIFIED_WORK_AREAS</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rtems/confdefs.h&gt;</span>
</pre></div>
</div>
<p>Then compile it, using any required flags found in the <code class="docutils literal notranslate"><span class="pre">.pc</span></code> file mentioned
above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">arm</span><span class="o">-</span><span class="n">rtems6</span><span class="o">-</span><span class="n">gcc</span> <span class="o">-</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">hello</span><span class="o">.</span><span class="n">o</span> <span class="o">-</span><span class="n">I</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="n">arm</span><span class="o">-</span><span class="n">rtems6</span><span class="o">/</span><span class="n">raspberrypi</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">include</span> <span class="o">-</span><span class="n">mcpu</span><span class="o">=</span><span class="n">arm1176jzf</span><span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">ffunction</span><span class="o">-</span><span class="n">sections</span> <span class="o">-</span><span class="n">fdata</span><span class="o">-</span><span class="n">sections</span> <span class="n">hello</span><span class="o">.</span><span class="n">c</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">arm</span><span class="o">-</span><span class="n">rtems6</span><span class="o">-</span><span class="n">gcc</span> <span class="o">-</span><span class="n">o</span> <span class="n">hello</span><span class="o">.</span><span class="n">elf</span> <span class="o">-</span><span class="n">mcpu</span><span class="o">=</span><span class="n">arm1176jzf</span><span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">B</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="n">arm</span><span class="o">-</span><span class="n">rtems6</span><span class="o">/</span><span class="n">raspberrypi</span><span class="o">/</span><span class="n">lib</span> <span class="o">-</span><span class="n">qrtems</span> <span class="o">-</span><span class="n">Wl</span><span class="p">,</span><span class="o">--</span><span class="n">gc</span><span class="o">-</span><span class="n">sections</span> <span class="n">hello</span><span class="o">.</span><span class="n">o</span>
</pre></div>
</div>
</section>
<section id="build-the-bootgen-tool-zynq-zynqmp-targets">
<h3>Build the bootgen tool (Zynq/ZynqMP Targets)<a class="headerlink" href="#build-the-bootgen-tool-zynq-zynqmp-targets" title="Permalink to this heading"></a></h3>
<p>First, pull down the <code class="docutils literal notranslate"><span class="pre">bootgen</span></code> source repository and (optionally) check out
the specific revision that was used when writing these notes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">Xilinx</span><span class="o">/</span><span class="n">bootgen</span><span class="o">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">bootgen</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="n">xilinx_v2021</span><span class="mf">.1</span>
</pre></div>
</div>
<p>Now make sure that you have the <code class="docutils literal notranslate"><span class="pre">libssl-dev</span></code> package required in order to compile <code class="docutils literal notranslate"><span class="pre">bootgen</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">libssl</span><span class="o">-</span><span class="n">dev</span>
</pre></div>
</div>
<p>Now you can build <code class="docutils literal notranslate"><span class="pre">bootgen</span></code>:</p>
<blockquote>
<div><p>make</p>
</div></blockquote>
<p>This should generate the <code class="docutils literal notranslate"><span class="pre">bootgen</span></code> executable.</p>
<p>Note that later releases of this tool seem to generate warning messages for
the Zynq 7000 target when both an FSBL and bitstream are specified in a
<code class="docutils literal notranslate"><span class="pre">.bif</span></code> file.</p>
</section>
<section id="building-the-arm-trusted-firmware-for-zynqmp-targets">
<h3>Building the ARM Trusted Firmware for ZynqMP Targets<a class="headerlink" href="#building-the-arm-trusted-firmware-for-zynqmp-targets" title="Permalink to this heading"></a></h3>
<p>First, pull down the source code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">Xilinx</span><span class="o">/</span><span class="n">arm</span><span class="o">-</span><span class="n">trusted</span><span class="o">-</span><span class="n">firmware</span>
<span class="n">cd</span> <span class="n">arm</span><span class="o">-</span><span class="n">trusted</span><span class="o">-</span><span class="n">firmware</span>
</pre></div>
</div>
<p>Now build it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">aarch64</span><span class="o">-</span><span class="n">rtems6</span><span class="o">-</span> <span class="n">make</span> <span class="n">PLAT</span><span class="o">=</span><span class="n">zynqmp</span> <span class="n">RESET_TO_BL31</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>If you run into trouble, you can build with with debug output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">aarch64</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">elf</span><span class="o">-</span> <span class="n">make</span> <span class="n">PLAT</span><span class="o">=</span><span class="n">zynqmp</span> <span class="n">RESET_TO_BL31</span><span class="o">=</span><span class="mi">1</span> <span class="n">LOG_LEVEL</span><span class="o">=</span><span class="mi">50</span> <span class="n">ZYNQMP_ATF_MEM_BASE</span><span class="o">=</span><span class="mh">0x12000000</span> <span class="n">ZYNQMP_ATF_MEM_SIZE</span><span class="o">=</span><span class="mh">0x00100000</span>
</pre></div>
</div>
<p>This yields a <code class="docutils literal notranslate"><span class="pre">bl31.elf</span></code> file that is used with <code class="docutils literal notranslate"><span class="pre">bootgen</span></code>.</p>
</section>
<section id="building-the-pmu-firmware-for-zynqmp">
<h3>Building the PMU Firmware for ZynqMP<a class="headerlink" href="#building-the-pmu-firmware-for-zynqmp" title="Permalink to this heading"></a></h3>
<p>In Vivado SDK, perform the following steps:</p>
<ul class="simple">
<li><p>File-&gt;New-&gt;Application Project</p></li>
<li><p>Project name: pmu</p></li>
<li><p>Processor: psu_pmu_0</p></li>
<li><p>Next, PSU PMU Firmware, Finish</p></li>
<li><p>Yields pmu.elf</p></li>
</ul>
</section>
<section id="build-a-boot-image-for-zynq-targets">
<h3>Build a Boot Image for Zynq Targets<a class="headerlink" href="#build-a-boot-image-for-zynq-targets" title="Permalink to this heading"></a></h3>
<p>Create a file called <code class="docutils literal notranslate"><span class="pre">hello.bif</span></code> containing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">the_ROM_image</span><span class="p">:</span>
<span class="p">{</span>
  <span class="p">[</span><span class="n">bootloader</span><span class="p">]</span><span class="n">fsbl</span><span class="o">.</span><span class="n">elf</span>
  <span class="n">system_wrapper</span><span class="o">.</span><span class="n">bit</span>
  <span class="n">hello</span><span class="o">.</span><span class="n">elf</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">fsbl.elf</span></code> and <code class="docutils literal notranslate"><span class="pre">system_wrapper.bit</span></code> files are generated in Vivado.</p>
<p>Now generate a bootable image for the “Hello World” application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">bootgen</span> <span class="o">-</span><span class="n">arch</span> <span class="n">zynq</span> <span class="o">-</span><span class="n">image</span> <span class="n">hello</span><span class="o">.</span><span class="n">bif</span> <span class="o">-</span><span class="n">o</span> <span class="n">hello</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
</section>
<section id="build-a-boot-image-for-zynqmp-targets">
<h3>Build a Boot Image for ZynqMP Targets<a class="headerlink" href="#build-a-boot-image-for-zynqmp-targets" title="Permalink to this heading"></a></h3>
<p>Create a file called <code class="docutils literal notranslate"><span class="pre">hello.bif</span></code> containing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">the_ROM_image</span><span class="p">:</span>
<span class="p">{</span>
        <span class="o">//</span><span class="p">[</span><span class="n">pmufw_image</span><span class="p">]</span><span class="n">pmu</span><span class="o">.</span><span class="n">elf</span> <span class="o">//</span> <span class="n">pmu</span> <span class="n">fw</span> <span class="n">loaded</span> <span class="n">by</span> <span class="n">boot</span> <span class="n">rom</span>
        <span class="p">[</span><span class="n">bootloader</span><span class="p">,</span> <span class="n">destination_cpu</span><span class="o">=</span><span class="n">a53</span><span class="o">-</span><span class="mi">0</span><span class="p">]</span><span class="n">fsbl</span><span class="o">.</span><span class="n">elf</span>
        <span class="p">[</span><span class="n">destination_cpu</span><span class="o">=</span><span class="n">pmu</span><span class="p">]</span><span class="n">pmu</span><span class="o">.</span><span class="n">elf</span> <span class="o">//</span> <span class="n">pmu</span> <span class="n">fw</span> <span class="n">loaded</span> <span class="n">by</span> <span class="n">fsbl</span>
        <span class="p">[</span><span class="n">destination_device</span><span class="o">=</span><span class="n">pl</span><span class="p">]</span><span class="n">system_wrapper</span><span class="o">.</span><span class="n">bit</span> <span class="o">//</span> <span class="n">optional</span>
        <span class="p">[</span><span class="n">destination_cpu</span><span class="o">=</span><span class="n">a53</span><span class="o">-</span><span class="mi">0</span><span class="p">,</span> <span class="n">exception_level</span><span class="o">=</span><span class="n">el</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">trustzone</span><span class="p">]</span><span class="n">bl31</span><span class="o">.</span><span class="n">elf</span>
        <span class="p">[</span><span class="n">destination_cpu</span><span class="o">=</span><span class="n">a53</span><span class="o">-</span><span class="mi">0</span><span class="p">,</span> <span class="n">exception_level</span><span class="o">=</span><span class="n">el</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="n">hello</span><span class="o">.</span><span class="n">elf</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">fsbl.elf</span></code>, <code class="docutils literal notranslate"><span class="pre">pmu.elf</span></code> and <code class="docutils literal notranslate"><span class="pre">system_wrapper.bit</span></code> files are generated
in Vivado.</p>
<p>Now generate a bootable image for the “Hello World” application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">bootgen</span> <span class="o">-</span><span class="n">arch</span> <span class="n">zynqmp</span> <span class="o">-</span><span class="n">image</span> <span class="n">hello</span><span class="o">.</span><span class="n">bif</span> <span class="o">-</span><span class="n">o</span> <span class="n">hello</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
<section id="qemu-setup">
<h4>QEMU Setup<a class="headerlink" href="#qemu-setup" title="Permalink to this heading"></a></h4>
<p>If you want to emulate any of the ARM or AARCH64 targets, you will need to
install the QEMU emulator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">arm</span>
</pre></div>
</div>
</section>
</section>
<section id="raspberry-pi-setup">
<h3>Raspberry Pi Setup<a class="headerlink" href="#raspberry-pi-setup" title="Permalink to this heading"></a></h3>
<p>The following instructions were tested with a first-generation Raspberry Pi.</p>
<p>First, configure an SD card for booting the Raspberry Pi using the standard
process, but choose one of the minimal images.  On Ubuntu, this is best done
via:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">rpi</span><span class="o">-</span><span class="n">imager</span>
<span class="n">rpi</span><span class="o">-</span><span class="n">imager</span>
</pre></div>
</div>
<p>Choose the <code class="docutils literal notranslate"><span class="pre">Raspberry</span> <span class="pre">Pi</span> <span class="pre">OS</span> <span class="pre">Lite</span> <span class="pre">(Legacy/Buster)</span></code> image and write it to an
SD card.</p>
<p>The default configuration should have the serial boot console enabled.
Connect up something like the <a class="reference external" href="https://www.ftdichip.com/Support/Documents/DataSheets/Cables/DS_TTL-232R_CABLES.pdf">FTDI TTL-232R-3V3 cable</a>
to your PC.  With this cable, the yellow PC-RXD pin connects to the PI-TXD
(P1-PIN8), the black PC-GND pin connects to the PI-GND (P1-PIN6), and the
orange PC-TXD pin connects to the PI-RXD (P1-PIN10) as shown <a class="reference external" href="https://www.raspberrypi.com/documentation/computers/raspberry-pi.html">here</a>.</p>
<p>Now run the following command in a terminal window and power up the Pi with
the SD card inserted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">picocom</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">ttyUSB0</span> <span class="o">--</span><span class="n">b</span> <span class="mi">115200</span> <span class="o">--</span><span class="n">d</span> <span class="mi">8</span> <span class="o">--</span><span class="n">p</span> <span class="n">n</span> <span class="o">--</span><span class="n">f</span>
</pre></div>
</div>
<p>You should see kernel boot output.  Now type &lt;ctrl-a&gt;&lt;ctrl-q&gt; to quit
picocom.</p>
<p>Booting RTEMS currently requires an older version of the Pi firmware to be
installed on the SD card, so download a zip file with the required firmware
from <a class="reference external" href="https://github.com/raspberrypi/firmware/tree/1.20200601">this link</a>.
Checking out the whole Git repo takes a very long time.</p>
<p>Now mount the SD card boot partition and move all the files in that boot
directory into a subdirectory (except for <code class="docutils literal notranslate"><span class="pre">config.txt</span></code>), as they will be
replaced.  Now copy all the files from the boot directory of the zip file you
just downloaded onto the boot partition of the SD card:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">backup</span>
<span class="n">mv</span> <span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">boot</span><span class="o">/*</span> <span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">backup</span>
<span class="n">mv</span> <span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span><span class="n">config</span><span class="o">.</span><span class="n">txt</span> <span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">boot</span>
<span class="n">cp</span> <span class="o">-</span><span class="n">r</span> <span class="n">firmware</span><span class="o">-</span><span class="mf">1.20200601</span><span class="o">/</span><span class="n">boot</span><span class="o">/*</span> <span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">boot</span>
</pre></div>
</div>
<p>We also need to add the following lines to the end of <code class="docutils literal notranslate"><span class="pre">config.txt</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dtoverlay</span><span class="o">=</span><span class="n">disable</span><span class="o">-</span><span class="n">bt</span>
<span class="n">kernel_address</span><span class="o">=</span><span class="mh">0x200000</span>
<span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="o">.</span><span class="n">img</span>
</pre></div>
</div>
<p>You can test the booting of this configuration once more to make sure you
still see serial output.</p>
</section>
<section id="building-a-raspberry-pi-kernel-image">
<h3>Building a Raspberry Pi Kernel Image<a class="headerlink" href="#building-a-raspberry-pi-kernel-image" title="Permalink to this heading"></a></h3>
<p>In order to create a bootable image for use on the Raspberry Pi, you must run
the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">arm</span><span class="o">-</span><span class="n">rtems6</span><span class="o">-</span><span class="n">objcopy</span> <span class="o">-</span><span class="n">Obinary</span> <span class="n">hello</span><span class="o">.</span><span class="n">elf</span> <span class="n">kernel</span><span class="o">.</span><span class="n">img</span>
</pre></div>
</div>
</section>
<section id="booting-a-raspberry-pi-kernel-image">
<h3>Booting a Raspberry Pi Kernel Image<a class="headerlink" href="#booting-a-raspberry-pi-kernel-image" title="Permalink to this heading"></a></h3>
<p>You can now copy the <code class="docutils literal notranslate"><span class="pre">kernel.img</span></code> file you created previously onto the boot
partition of the Raspberry Pi SD card (overwriting the existing one) and
power up the board:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="n">kernel</span><span class="o">.</span><span class="n">img</span> <span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span>
</pre></div>
</div>
<p>You should text see output appear in the <code class="docutils literal notranslate"><span class="pre">picocom</span></code> terminal window that you
set up previously.</p>
</section>
<section id="booting-a-qemu-image">
<h3>Booting a QEMU Image<a class="headerlink" href="#booting-a-qemu-image" title="Permalink to this heading"></a></h3>
<p>For the Zynq 7000 QEMU target, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">arm</span> <span class="o">-</span><span class="n">serial</span> <span class="n">null</span> <span class="o">-</span><span class="n">serial</span> <span class="n">mon</span><span class="p">:</span><span class="n">stdio</span> <span class="o">-</span><span class="n">net</span> <span class="n">none</span> <span class="o">-</span><span class="n">nographic</span> <span class="o">-</span><span class="n">M</span> <span class="n">xilinx</span><span class="o">-</span><span class="n">zynq</span><span class="o">-</span><span class="n">a9</span> <span class="o">-</span><span class="n">m</span> <span class="mi">256</span><span class="n">M</span> <span class="o">-</span><span class="n">kernel</span> <span class="n">hello</span><span class="o">.</span><span class="n">elf</span>
</pre></div>
</div>
<p>Note that stdin does not appear to work for the Zynq 7000 QEMU target, but
stdout does.</p>
<p>For the Zynq 7000 QEMU target with ethernet emulation, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">arm</span> <span class="o">-</span><span class="n">serial</span> <span class="n">null</span> <span class="o">-</span><span class="n">serial</span> <span class="n">mon</span><span class="p">:</span><span class="n">stdio</span> <span class="o">-</span><span class="n">net</span> <span class="n">nic</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="n">cadence_gem</span><span class="p">,</span><span class="n">macaddr</span><span class="o">=</span><span class="mi">0</span><span class="n">e</span><span class="p">:</span><span class="n">b0</span><span class="p">:</span><span class="n">ba</span><span class="p">:</span><span class="mi">5</span><span class="n">e</span><span class="p">:</span><span class="n">ba</span><span class="p">:</span><span class="mi">11</span> <span class="o">-</span><span class="n">net</span> <span class="n">user</span><span class="p">,</span><span class="n">hostfwd</span><span class="o">=</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">2000</span><span class="o">-</span><span class="p">:</span><span class="mi">23</span> <span class="o">-</span><span class="n">nographic</span> <span class="o">-</span><span class="n">M</span> <span class="n">xilinx</span><span class="o">-</span><span class="n">zynq</span><span class="o">-</span><span class="n">a9</span> <span class="o">-</span><span class="n">m</span> <span class="mi">256</span><span class="n">M</span> <span class="o">-</span><span class="n">kernel</span> <span class="n">hello</span><span class="o">.</span><span class="n">elf</span>
</pre></div>
</div>
<p>For the ZynqMP QEMU target, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">aarch64</span> <span class="o">-</span><span class="n">serial</span> <span class="n">mon</span><span class="p">:</span><span class="n">stdio</span> <span class="o">-</span><span class="n">net</span> <span class="n">none</span> <span class="o">-</span><span class="n">nographic</span> <span class="o">-</span><span class="n">machine</span> <span class="n">xlnx</span><span class="o">-</span><span class="n">zcu102</span> <span class="o">-</span><span class="n">m</span> <span class="mi">4096</span> <span class="o">-</span><span class="n">kernel</span> <span class="n">hello</span><span class="o">.</span><span class="n">elf</span>
</pre></div>
</div>
<p>For the ZynqMP QEMU target with ethernet emulation, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">aarch64</span> <span class="o">-</span><span class="n">serial</span> <span class="n">mon</span><span class="p">:</span><span class="n">stdio</span> <span class="o">-</span><span class="n">net</span> <span class="n">nic</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="n">cadence_gem</span><span class="p">,</span><span class="n">macaddr</span><span class="o">=</span><span class="mi">0</span><span class="n">e</span><span class="p">:</span><span class="n">b0</span><span class="p">:</span><span class="n">ba</span><span class="p">:</span><span class="mi">5</span><span class="n">e</span><span class="p">:</span><span class="n">ba</span><span class="p">:</span><span class="mi">11</span> <span class="o">-</span><span class="n">net</span> <span class="n">user</span><span class="p">,</span><span class="n">hostfwd</span><span class="o">=</span><span class="n">tcp</span><span class="p">:</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">2000</span><span class="o">-</span><span class="p">:</span><span class="mi">23</span> <span class="o">-</span><span class="n">nographic</span> <span class="o">-</span><span class="n">machine</span> <span class="n">xlnx</span><span class="o">-</span><span class="n">zcu102</span> <span class="o">-</span><span class="n">m</span> <span class="mi">4096</span> <span class="o">-</span><span class="n">kernel</span> <span class="n">hello</span><span class="o">.</span><span class="n">elf</span>
</pre></div>
</div>
<p>To exit or issue QEMU commands, use these key sequences:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Ctrl</span><span class="o">-</span><span class="n">a</span> <span class="n">h</span> <span class="o">-&gt;</span> <span class="n">Help</span>
<span class="n">Ctrl</span><span class="o">-</span><span class="n">a</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Exit</span> <span class="n">QEMU</span>
</pre></div>
</div>
</section>
<section id="booting-a-microzed-boot-bin-image">
<h3>Booting a MicroZed BOOT.BIN Image<a class="headerlink" href="#booting-a-microzed-boot-bin-image" title="Permalink to this heading"></a></h3>
<p>Now copy the <code class="docutils literal notranslate"><span class="pre">hello.bin</span></code> file (generated via <code class="docutils literal notranslate"><span class="pre">bootgen</span></code>) into the root
directory of a MicroZed’s SD card, renaming it <code class="docutils literal notranslate"><span class="pre">BOOT.BIN</span></code>.</p>
<p>Now put the SD card into the MicroZed and boot it up.</p>
<p>Before turning on power to the development board, connect up the USB UART
cable to your workstation and run this command in a terminal window:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">picocom</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">ttyUSB0</span> <span class="o">--</span><span class="n">b</span> <span class="mi">115200</span> <span class="o">--</span><span class="n">d</span> <span class="mi">8</span> <span class="o">--</span><span class="n">p</span> <span class="n">n</span> <span class="o">--</span><span class="n">f</span> <span class="n">n</span>
</pre></div>
</div>
<p>Now type &lt;ctrl-a&gt;&lt;ctrl-q&gt; to quit picocom.</p>
</section>
<section id="booting-an-ultrazed-boot-bin-image">
<h3>Booting an UltraZed BOOT.BIN Image<a class="headerlink" href="#booting-an-ultrazed-boot-bin-image" title="Permalink to this heading"></a></h3>
<p>Now copy the <code class="docutils literal notranslate"><span class="pre">hello.bin</span></code> file (generated via <code class="docutils literal notranslate"><span class="pre">bootgen</span></code>) into the root
directory of an UltaZed’s SD card, renaming it <code class="docutils literal notranslate"><span class="pre">BOOT.BIN</span></code>.</p>
<p>Now put the SD card into the UltraZed and boot it up.</p>
<p>Before turning on power to the development board, connect up the USB UART
cable to your workstation and run this command in a terminal window:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">picocom</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">ttyUSB1</span> <span class="o">--</span><span class="n">b</span> <span class="mi">115200</span> <span class="o">--</span><span class="n">d</span> <span class="mi">8</span> <span class="o">--</span><span class="n">p</span> <span class="n">n</span> <span class="o">--</span><span class="n">f</span> <span class="n">n</span>
</pre></div>
</div>
<p>Now type &lt;ctrl-a&gt;&lt;ctrl-q&gt; to quit picocom.</p>
</section>
<section id="build-libbsd-for-rtems-optional">
<h3>Build libbsd for RTEMS (Optional)<a class="headerlink" href="#build-libbsd-for-rtems-optional" title="Permalink to this heading"></a></h3>
<p>If you want extra features like networking and SD card drivers, you will also
need to build <code class="docutils literal notranslate"><span class="pre">libbsd</span></code>.</p>
<p>In order to do this, first pull down the <code class="docutils literal notranslate"><span class="pre">rtems-libbsd</span></code> source repository
and (optionally) check out the required branch that works with RTEMS (commit
<code class="docutils literal notranslate"><span class="pre">ac4cf946a28329cc65cbc0c30ec1ed0d6449d7cc</span></code> was used when writing these
notes):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">git</span><span class="p">:</span><span class="o">//</span><span class="n">git</span><span class="o">.</span><span class="n">rtems</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">rtems</span><span class="o">-</span><span class="n">libbsd</span><span class="o">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">rtems</span><span class="o">-</span><span class="n">libbsd</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="mi">6</span><span class="o">-</span><span class="n">freebsd</span><span class="o">-</span><span class="mi">12</span>
<span class="n">git</span> <span class="n">submodule</span> <span class="n">init</span>
<span class="n">git</span> <span class="n">submodule</span> <span class="n">update</span> <span class="n">rtems_waf</span>
<span class="o">./</span><span class="n">waf</span> <span class="n">configure</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span> \
  <span class="o">--</span><span class="n">rtems</span><span class="o">-</span><span class="n">bsps</span><span class="o">=</span><span class="s2">&quot;aarch64/xilinx_zynqmp_lp64_zu3eg&quot;</span> \
  <span class="o">--</span><span class="n">buildset</span><span class="o">=</span><span class="n">buildset</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">ini</span>
<span class="o">./</span><span class="n">waf</span>
<span class="o">./</span><span class="n">waf</span> <span class="n">install</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>With the appropriate command-line options, libbsd can alternatively be built
from an “out-of-tree” build directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/path/to/libbsd/waf --prefix=/opt/rsb-tools-rtems-6-f0e34ea --rtems-bsps=&quot;aarch64/xilinx_zynqmp_lp64_zu3eg&quot; --buildset=buildset/default.ini --out=$PWD/build --top=/path/to/libbsd configure

/path/to/libbsd/waf --prefix=/opt/rsb-tools-rtems-6-f0e34ea --rtems-bsps=&quot;aarch64/xilinx_zynqmp_lp64_zu3eg&quot; --buildset=buildset/default.ini --out=$PWD/build --top=/path/to/libbsd

/path/to/libbsd/waf --prefix=/opt/rsb-tools-rtems-6-f0e34ea --rtems-bsps=&quot;aarch64/xilinx_zynqmp_lp64_zu3eg&quot; --buildset=buildset/default.ini --out=$PWD/build --top=/path/to/libbsd install
</pre></div>
</div>
<p>Please note that (unlike the RTEMS out-of-tree build) the
<code class="docutils literal notranslate"><span class="pre">--no-lock-in-top</span></code> and <code class="docutils literal notranslate"><span class="pre">--no-lock-in-run</span></code> options cannot be specified
because the waf configuration is loaded from the lock files during the
“build” phase.</p>
</div>
</section>
<section id="an-application-to-test-libbsd">
<h3>An Application to Test libbsd<a class="headerlink" href="#an-application-to-test-libbsd" title="Permalink to this heading"></a></h3>
<p>In order to test <code class="docutils literal notranslate"><span class="pre">libbsd</span></code>, you can create a file called <code class="docutils literal notranslate"><span class="pre">netcon.c</span></code>
containing:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rtems/shell.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rtems/bsd/bsd.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;machine/rtems-bsd-rc-conf.h&gt;</span>

<span class="cp">#define BOARD_ETH_IFC &quot;cgem0&quot; </span><span class="c1">// microzed and ultrazed</span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">rc_conf_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\
<span class="w">  </span><span class="s">&quot;hostname=</span><span class="se">\&quot;</span><span class="s">rtems</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="w"> </span>\
<span class="w">  </span><span class="s">&quot;ifconfig_&quot;</span><span class="w"> </span><span class="n">BOARD_ETH_IFC</span><span class="w"> </span><span class="s">&quot;=</span><span class="se">\&quot;</span><span class="s">inet 172.18.14.227 netmask 255.255.0.0</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="w"> </span>\
<span class="w">  </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">POSIX_Init</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">rtems_status_code</span><span class="w"> </span><span class="n">sc</span><span class="p">;</span>

<span class="w">    </span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtems_bsd_initialize</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RTEMS_SUCCESSFUL</span><span class="p">)</span>
<span class="w">        </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;rtems_bsd_initialize error: %s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">rtems_status_text</span><span class="w"> </span><span class="p">(</span><span class="n">sc</span><span class="p">),</span><span class="w"> </span><span class="n">sc</span><span class="p">);</span>

<span class="w">    </span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtems_bsd_run_rc_conf_script</span><span class="p">(</span><span class="s">&quot;internal&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rc_conf_text</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RTEMS_SUCCESSFUL</span><span class="p">)</span>
<span class="w">        </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;rtems_bsd_run_rc_conf_script error: %s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">rtems_status_text</span><span class="w"> </span><span class="p">(</span><span class="n">sc</span><span class="p">),</span><span class="w"> </span><span class="n">sc</span><span class="p">);</span>

<span class="w">    </span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtems_task_wake_after</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RTEMS_SUCCESSFUL</span><span class="p">)</span>
<span class="w">        </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;rtems_task_wake_after error: %s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">rtems_status_text</span><span class="w"> </span><span class="p">(</span><span class="n">sc</span><span class="p">),</span><span class="w"> </span><span class="n">sc</span><span class="p">);</span>

<span class="w">    </span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtems_shell_init</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;net_shell&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="mi">150</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/dev/console&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RTEMS_SUCCESSFUL</span><span class="p">)</span>
<span class="w">        </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;rtems_shell_init error: %s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">rtems_status_text</span><span class="w"> </span><span class="p">(</span><span class="n">sc</span><span class="p">),</span><span class="w"> </span><span class="n">sc</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RTEMS_BSD_CONFIG_BSP_CONFIG</span>
<span class="cp">#define RTEMS_BSD_CONFIG_INIT</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;machine/rtems-bsd-config.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rtems/netcmds-config.h&gt;</span>
<span class="cp">#define CONFIGURE_SHELL_USER_COMMANDS \</span>
<span class="cp">  &amp;rtems_shell_ARP_Command, \</span>
<span class="cp">  &amp;rtems_shell_HOSTNAME_Command, \</span>
<span class="cp">  &amp;rtems_shell_PING_Command, \</span>
<span class="cp">  &amp;rtems_shell_ROUTE_Command, \</span>
<span class="cp">  &amp;rtems_shell_NETSTAT_Command, \</span>
<span class="cp">  &amp;rtems_shell_IFCONFIG_Command</span>
<span class="cp">#define CONFIGURE_SHELL_COMMANDS_ALL</span>
<span class="cp">#define CONFIGURE_SHELL_COMMANDS_INIT</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rtems/shellconfig.h&gt;</span>

<span class="cp">#define CONFIGURE_APPLICATION_NEEDS_CONSOLE_DRIVER</span>
<span class="cp">#define CONFIGURE_APPLICATION_NEEDS_CLOCK_DRIVER</span>
<span class="cp">#define CONFIGURE_POSIX_INIT_THREAD_TABLE</span>
<span class="cp">#define CONFIGURE_INIT</span>
<span class="cp">#define CONFIGURE_UNLIMITED_OBJECTS</span>
<span class="cp">#define CONFIGURE_UNIFIED_WORK_AREAS</span>
<span class="cp">#define CONFIGURE_MAXIMUM_FILE_DESCRIPTORS 80</span>
<span class="cp">#define CONFIGURE_APPLICATION_NEEDS_LIBBLOCK</span>
<span class="cp">#define CONFIGURE_MAXIMUM_USER_EXTENSIONS 1</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rtems/confdefs.h&gt;</span>
</pre></div>
</div>
<p>And then compile it as before, but link in <code class="docutils literal notranslate"><span class="pre">libbsd</span></code> and <code class="docutils literal notranslate"><span class="pre">libm</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">arm</span><span class="o">-</span><span class="n">rtems6</span><span class="o">-</span><span class="n">gcc</span> <span class="o">-</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">netcon</span><span class="o">.</span><span class="n">o</span> <span class="o">-</span><span class="n">I</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="n">arm</span><span class="o">-</span><span class="n">rtems6</span><span class="o">/</span><span class="n">raspberrypi</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">include</span> <span class="o">-</span><span class="n">mcpu</span><span class="o">=</span><span class="n">arm1176jzf</span><span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">ffunction</span><span class="o">-</span><span class="n">sections</span> <span class="o">-</span><span class="n">fdata</span><span class="o">-</span><span class="n">sections</span> <span class="n">netcon</span><span class="o">.</span><span class="n">c</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">arm</span><span class="o">-</span><span class="n">rtems6</span><span class="o">-</span><span class="n">gcc</span> <span class="o">-</span><span class="n">o</span> <span class="n">netcon</span><span class="o">.</span><span class="n">elf</span> <span class="o">-</span><span class="n">mcpu</span><span class="o">=</span><span class="n">arm1176jzf</span><span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">B</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="n">arm</span><span class="o">-</span><span class="n">rtems6</span><span class="o">/</span><span class="n">raspberrypi</span><span class="o">/</span><span class="n">lib</span> <span class="o">-</span><span class="n">qrtems</span> <span class="o">-</span><span class="n">Wl</span><span class="p">,</span><span class="o">--</span><span class="n">gc</span><span class="o">-</span><span class="n">sections</span> <span class="n">netcon</span><span class="o">.</span><span class="n">o</span> <span class="o">-</span><span class="n">lbsd</span> <span class="o">-</span><span class="n">lm</span>
</pre></div>
</div>
<p>Note that ethernet does not currently work for the Raspberry Pi, but does for
the MicroZed and UltraZed.</p>
</section>
<section id="tools-for-examining-executables">
<h3>Tools for Examining Executables<a class="headerlink" href="#tools-for-examining-executables" title="Permalink to this heading"></a></h3>
<p>Print the size of an executable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">rtems6</span><span class="o">-</span><span class="n">size</span> <span class="n">hello</span><span class="o">.</span><span class="n">elf</span>
</pre></div>
</div>
<p>To see the memory layout of an executable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">rtems6</span><span class="o">-</span><span class="n">readelf</span> <span class="o">-</span><span class="n">S</span> <span class="n">hello</span><span class="o">.</span><span class="n">elf</span>
</pre></div>
</div>
</section>
<section id="building-u-boot-optional">
<h3>Building U-Boot (Optional)<a class="headerlink" href="#building-u-boot-optional" title="Permalink to this heading"></a></h3>
<p>If you have a need for a more sophisticated bootloader, you can set up
U-Boot.</p>
<p>In order to do this, first pull down the <code class="docutils literal notranslate"><span class="pre">u-boot</span></code> source repository and
(optionally) check out the commit that was used when writing these notes):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">Xilinx</span><span class="o">/</span><span class="n">u</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">xlnx</span><span class="o">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">u</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">xlnx</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="n">xilinx</span><span class="o">-</span><span class="n">v2022</span><span class="mf">.2</span>
</pre></div>
</div>
<p>The (forked) URL/commit above is applicable to the Xilinx Zynq and ZynqMP
boards.  For other targets (like the Raspberry Pi), the master repository
should be used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">u</span><span class="o">-</span><span class="n">boot</span><span class="o">/</span><span class="n">u</span><span class="o">-</span><span class="n">boot</span><span class="o">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">u</span><span class="o">-</span><span class="n">boot</span>
</pre></div>
</div>
<p>You can see the available boards and device trees in places like these:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ls</span> <span class="n">configs</span><span class="o">/</span><span class="n">xilinx_zynq_virt_defconfig</span>
<span class="n">ls</span> <span class="n">arch</span><span class="o">/</span><span class="n">arm</span><span class="o">/</span><span class="n">dts</span><span class="o">/</span><span class="n">zynq</span><span class="o">-</span><span class="n">microzed</span><span class="o">.</span><span class="n">dts</span>

<span class="n">ls</span> <span class="n">configs</span><span class="o">/</span><span class="n">rpi_defconfig</span>
<span class="n">ls</span> <span class="n">arch</span><span class="o">/</span><span class="n">arm</span><span class="o">/</span><span class="n">dts</span><span class="o">/</span><span class="n">bcm2835</span><span class="o">-</span><span class="n">rpi</span><span class="o">-</span><span class="n">b</span><span class="o">.</span><span class="n">dts</span>
</pre></div>
</div>
<p>To configure for the MicroZed board, issue these commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">CROSS_COMPILE</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">arm</span><span class="o">-</span><span class="n">rtems6</span><span class="o">-</span>
<span class="n">export</span> <span class="n">DEVICE_TREE</span><span class="o">=</span><span class="n">zynq</span><span class="o">-</span><span class="n">microzed</span>
<span class="n">make</span> <span class="n">xilinx_zynq_virt_defconfig</span>
</pre></div>
</div>
<p>For the UltraZed, issue these commands instead:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">CROSS_COMPILE</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">rtems6</span><span class="o">-</span>
<span class="n">export</span> <span class="n">DEVICE_TREE</span><span class="o">=</span><span class="n">avnet</span><span class="o">-</span><span class="n">ultrazedev</span><span class="o">-</span><span class="n">cc</span><span class="o">-</span><span class="n">v1</span><span class="mf">.0</span><span class="o">-</span><span class="n">ultrazedev</span><span class="o">-</span><span class="n">som</span><span class="o">-</span><span class="n">v1</span><span class="mf">.0</span>
<span class="n">make</span> <span class="n">avnet_ultrazedev_cc_v1_0_ultrazedev_som_v1_0_defconfig</span>
</pre></div>
</div>
<p>You will also need to follow these steps for the UltraZed:</p>
<ul class="simple">
<li><p>Run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">menuconfig</span></code></p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Device</span> <span class="pre">Drivers</span></code></p></li>
<li><p>Then select <code class="docutils literal notranslate"><span class="pre">SOC</span> <span class="pre">specific</span> <span class="pre">Drivers</span></code></p></li>
<li><p>Then select <code class="docutils literal notranslate"><span class="pre">Enable</span> <span class="pre">SOC</span> <span class="pre">Device</span> <span class="pre">ID</span> <span class="pre">driver</span> <span class="pre">for</span> <span class="pre">Xilinx</span> <span class="pre">ZynqMP</span></code></p></li>
<li><p>Save and exit</p></li>
</ul>
<p>For the UltraZed ethernet to work, you must also change <code class="docutils literal notranslate"><span class="pre">reg</span> <span class="pre">=</span> <span class="pre">&lt;0&gt;</span></code> to
<code class="docutils literal notranslate"><span class="pre">reg</span> <span class="pre">=</span> <span class="pre">&lt;9&gt;</span></code> in <code class="docutils literal notranslate"><span class="pre">arch/arm/dts/avnet-ultrazedev-som-v1.0.dtsi</span></code>.</p>
<p>If you want to use TFTP boot with a non-privileged server port, you will need
to remove this <code class="docutils literal notranslate"><span class="pre">#ifdef</span></code> line (and the corresponding <code class="docutils literal notranslate"><span class="pre">#endif</span></code> line) in
<code class="docutils literal notranslate"><span class="pre">net/tftp.c</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#ifdef CONFIG_TFTP_PORT</span>
</pre></div>
</div>
<p>To kick off the build do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="o">-</span><span class="n">j</span>
</pre></div>
</div>
<p>This build process should result in a <code class="docutils literal notranslate"><span class="pre">u-boot.elf</span></code> in the top-level
directory.  For Zynq/ZynqMP targets a <code class="docutils literal notranslate"><span class="pre">BOOT.BIN</span></code> file can be created using
<code class="docutils literal notranslate"><span class="pre">bootgen</span></code> following the previous instructions and replacing <code class="docutils literal notranslate"><span class="pre">hello.elf</span></code>
with <code class="docutils literal notranslate"><span class="pre">u-boot.elf</span></code>.  The resulting BOOT.BIN should be able to boot on the
target board.  For the the Raspberry Pi, the <code class="docutils literal notranslate"><span class="pre">u-boot.elf</span></code> file can be used
to create a <code class="docutils literal notranslate"><span class="pre">kernel.img</span></code> in the same way that was done for <code class="docutils literal notranslate"><span class="pre">hello.elf</span></code>.</p>
<p>If you want to clean everything up to build for another board, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">distclean</span>
</pre></div>
</div>
</section>
<section id="basic-u-boot-configuration-for-the-microzed-optional">
<h3>Basic U-Boot Configuration for the MicroZed (Optional)<a class="headerlink" href="#basic-u-boot-configuration-for-the-microzed-optional" title="Permalink to this heading"></a></h3>
<p>You can add a <code class="docutils literal notranslate"><span class="pre">boot.scr</span></code> file to the root SD card partition to customize
what u-boot does when it boots up.  As an example, create a text file named
<code class="docutils literal notranslate"><span class="pre">boot.txt</span></code> containing the following text:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fatload</span> <span class="n">mmc</span> <span class="mi">0</span> <span class="mh">0x104000</span> <span class="n">hello</span><span class="o">.</span><span class="n">img</span>
<span class="n">echo</span> <span class="s2">&quot;Booting hello.img from SD card...&quot;</span>
<span class="n">bootm</span> <span class="mh">0x104000</span>
</pre></div>
</div>
<p>These commands instruct u-boot to look for a file named <code class="docutils literal notranslate"><span class="pre">hello.img</span></code> on the
SD card, load it into memory at the specified address, and then run it.</p>
<p>Now we need to convert this text file to an <code class="docutils literal notranslate"><span class="pre">.scr</span></code> script image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">u</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">xlnx</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">mkimage</span> <span class="o">-</span><span class="n">A</span> <span class="n">arm</span> <span class="o">-</span><span class="n">T</span> <span class="n">script</span> <span class="o">-</span><span class="n">C</span> <span class="n">none</span> <span class="o">-</span><span class="n">n</span> <span class="s2">&quot;Boot Script&quot;</span> <span class="o">-</span><span class="n">d</span> <span class="n">boot</span><span class="o">.</span><span class="n">txt</span> <span class="n">boot</span><span class="o">.</span><span class="n">scr</span>
</pre></div>
</div>
<p>The resulting <code class="docutils literal notranslate"><span class="pre">boot.scr</span></code> file can then be copied into the root directory of
the SD card.</p>
<p>Now we need to convert our <code class="docutils literal notranslate"><span class="pre">hello.elf</span></code> file into a binary image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">arm</span><span class="o">-</span><span class="n">rtems6</span><span class="o">-</span><span class="n">objcopy</span> <span class="o">-</span><span class="n">R</span> <span class="o">-</span><span class="n">S</span> <span class="o">-</span><span class="n">Obinary</span> <span class="n">hello</span><span class="o">.</span><span class="n">elf</span> <span class="n">hello</span><span class="o">.</span><span class="n">binary</span>
</pre></div>
</div>
<p>Now we need to make a <code class="docutils literal notranslate"><span class="pre">u-boot</span></code> image from the binary image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">u</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">xlnx</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">mkimage</span> <span class="o">-</span><span class="n">A</span> <span class="n">arm</span> <span class="o">-</span><span class="n">O</span> <span class="n">rtems</span> <span class="o">-</span><span class="n">T</span> <span class="n">kernel</span> <span class="o">-</span><span class="n">C</span> <span class="n">none</span> <span class="o">-</span><span class="n">a</span> <span class="mh">0x104000</span> <span class="o">-</span><span class="n">e</span> <span class="mh">0x104000</span> <span class="o">-</span><span class="n">n</span> <span class="s2">&quot;Hello World&quot;</span> <span class="o">-</span><span class="n">d</span> <span class="n">hello</span><span class="o">.</span><span class="n">binary</span> <span class="n">hello</span><span class="o">.</span><span class="n">img</span>
</pre></div>
</div>
<p>Now copy the resulting <code class="docutils literal notranslate"><span class="pre">hello.img</span></code> output file onto the root partition of
the SD card and boot up the board.</p>
</section>
<section id="basic-u-boot-configuration-for-the-ultrazed-optional">
<h3>Basic U-Boot Configuration for the UltraZed (Optional)<a class="headerlink" href="#basic-u-boot-configuration-for-the-ultrazed-optional" title="Permalink to this heading"></a></h3>
<p>You can add a <code class="docutils literal notranslate"><span class="pre">boot.scr</span></code> file to the root SD card partition to customize
what u-boot does when it boots up.  As an example, create a text file named
<code class="docutils literal notranslate"><span class="pre">boot.txt</span></code> containing the following text:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fatload</span> <span class="n">mmc</span> <span class="mi">1</span> <span class="mh">0x10000000</span> <span class="n">hello</span><span class="o">.</span><span class="n">img</span>
<span class="n">echo</span> <span class="s2">&quot;Booting hello.img from SD card...&quot;</span>
<span class="n">bootm</span> <span class="mh">0x10000000</span>
</pre></div>
</div>
<p>These commands instruct u-boot to look for a file named <code class="docutils literal notranslate"><span class="pre">hello.img</span></code> on the
SD card, load it into memory at the specified address, and then run it.</p>
<p>Now we need to convert this text file to an <code class="docutils literal notranslate"><span class="pre">.scr</span></code> script image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">u</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">xlnx</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">mkimage</span> <span class="o">-</span><span class="n">A</span> <span class="n">arm64</span> <span class="o">-</span><span class="n">T</span> <span class="n">script</span> <span class="o">-</span><span class="n">C</span> <span class="n">none</span> <span class="o">-</span><span class="n">n</span> <span class="s2">&quot;Boot Script&quot;</span> <span class="o">-</span><span class="n">d</span> <span class="n">boot</span><span class="o">.</span><span class="n">txt</span> <span class="n">boot</span><span class="o">.</span><span class="n">scr</span>
</pre></div>
</div>
<p>The resulting <code class="docutils literal notranslate"><span class="pre">boot.scr</span></code> file can then be copied into the root directory of
the SD card.</p>
<p>Now we need to convert our <code class="docutils literal notranslate"><span class="pre">hello.elf</span></code> file into a binary image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">rtems6</span><span class="o">-</span><span class="n">objcopy</span> <span class="o">-</span><span class="n">R</span> <span class="o">-</span><span class="n">S</span> <span class="o">-</span><span class="n">Obinary</span> <span class="n">hello</span><span class="o">.</span><span class="n">elf</span> <span class="n">hello</span><span class="o">.</span><span class="n">binary</span>
</pre></div>
</div>
<p>Now we need to make a <code class="docutils literal notranslate"><span class="pre">u-boot</span></code> image from the binary image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">u</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">xlnx</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">mkimage</span> <span class="o">-</span><span class="n">A</span> <span class="n">arm64</span> <span class="o">-</span><span class="n">O</span> <span class="n">rtems</span> <span class="o">-</span><span class="n">T</span> <span class="n">kernel</span> <span class="o">-</span><span class="n">C</span> <span class="n">none</span> <span class="o">-</span><span class="n">a</span> <span class="mh">0x10000000</span> <span class="o">-</span><span class="n">e</span> <span class="mh">0x10000000</span> <span class="o">-</span><span class="n">n</span> <span class="s2">&quot;Hello World&quot;</span> <span class="o">-</span><span class="n">d</span> <span class="n">hello</span><span class="o">.</span><span class="n">binary</span> <span class="n">hello</span><span class="o">.</span><span class="n">img</span>
</pre></div>
</div>
<p>Now copy the resulting <code class="docutils literal notranslate"><span class="pre">hello.img</span></code> output file onto the root partition of
the SD card and boot up the board.</p>
</section>
<section id="tftp-boot-on-the-microzed-optional">
<h3>TFTP Boot on the MicroZed (Optional)<a class="headerlink" href="#tftp-boot-on-the-microzed-optional" title="Permalink to this heading"></a></h3>
<p>If we want to boot the MicroZed via TFTP, we can update the <code class="docutils literal notranslate"><span class="pre">boot.txt</span></code> as
follows, re-generate <code class="docutils literal notranslate"><span class="pre">boot.scr</span></code> and copy that to the SD card as before:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="nb">set</span> <span class="n">tftpdstp</span> <span class="mi">54321</span>
<span class="n">env</span> <span class="nb">set</span> <span class="n">serverip</span> <span class="mf">192.168.1.222</span>
<span class="n">env</span> <span class="nb">set</span> <span class="n">ipaddr</span> <span class="mf">192.168.1.111</span>
<span class="n">env</span> <span class="nb">set</span> <span class="n">netmask</span> <span class="mf">255.255.0.0</span>
<span class="n">echo</span> <span class="s2">&quot;Starting application from tftp...&quot;</span>
<span class="n">ping</span> <span class="mf">192.168.1.222</span>
<span class="n">tftpboot</span> <span class="mh">0x104000</span> <span class="n">hello</span><span class="o">.</span><span class="n">img</span>
<span class="n">bootm</span> <span class="mh">0x104000</span>
</pre></div>
</div>
<p>Just replace the network addresses/netmask with something applicable to your
setup.</p>
<p>Before powering up the target board, run the following command on your
development host machine from the directory containing <code class="docutils literal notranslate"><span class="pre">hello.img</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">rtems</span><span class="o">-</span><span class="n">tftp</span><span class="o">-</span><span class="n">server</span> <span class="o">-</span><span class="n">P</span> <span class="mi">54321</span> <span class="o">-</span><span class="n">v</span> <span class="o">--</span><span class="n">trace</span><span class="o">-</span><span class="n">packets</span>
</pre></div>
</div>
<p>If you want to change the name of the image being loaded without updating
<code class="docutils literal notranslate"><span class="pre">boot.scr</span></code> on the target system, you can do something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">rtems</span><span class="o">-</span><span class="n">tftp</span><span class="o">-</span><span class="n">server</span> <span class="o">-</span><span class="n">P</span> <span class="mi">54321</span> <span class="o">-</span><span class="n">F</span> <span class="n">net_shell</span><span class="o">.</span><span class="n">img</span>
</pre></div>
</div>
</section>
<section id="tftp-boot-on-the-ultrazed-optional">
<h3>TFTP Boot on the UltraZed (Optional)<a class="headerlink" href="#tftp-boot-on-the-ultrazed-optional" title="Permalink to this heading"></a></h3>
<p>If we want to boot the UltraZed via TFTP, we can update the <code class="docutils literal notranslate"><span class="pre">boot.txt</span></code> as
follows, re-generate <code class="docutils literal notranslate"><span class="pre">boot.scr</span></code> and copy that to the SD card as before:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="nb">set</span> <span class="n">tftpdstp</span> <span class="mi">54321</span>
<span class="n">env</span> <span class="nb">set</span> <span class="n">serverip</span> <span class="mf">192.168.1.222</span>
<span class="n">env</span> <span class="nb">set</span> <span class="n">ipaddr</span> <span class="mf">192.168.1.111</span>
<span class="n">env</span> <span class="nb">set</span> <span class="n">netmask</span> <span class="mf">255.255.0.0</span>
<span class="n">echo</span> <span class="s2">&quot;Starting application from tftp...&quot;</span>
<span class="n">ping</span> <span class="mf">192.168.1.222</span>
<span class="n">tftpboot</span> <span class="mh">0x10000000</span> <span class="n">hello</span><span class="o">.</span><span class="n">img</span>
<span class="n">bootm</span> <span class="mh">0x10000000</span>
</pre></div>
</div>
<p>Just replace the network addresses/netmask with something applicable to your
setup.</p>
<p>Before powering up the target board, run the following command on your
development host machine from the directory containing <code class="docutils literal notranslate"><span class="pre">hello.img</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">rtems</span><span class="o">-</span><span class="n">tftp</span><span class="o">-</span><span class="n">server</span> <span class="o">-</span><span class="n">P</span> <span class="mi">54321</span> <span class="o">-</span><span class="n">v</span> <span class="o">--</span><span class="n">trace</span><span class="o">-</span><span class="n">packets</span>
</pre></div>
</div>
<p>If you want to change the name of the image being loaded without updating
<code class="docutils literal notranslate"><span class="pre">boot.scr</span></code> on the target system, you can do something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">rtems</span><span class="o">-</span><span class="n">tftp</span><span class="o">-</span><span class="n">server</span> <span class="o">-</span><span class="n">P</span> <span class="mi">54321</span> <span class="o">-</span><span class="n">F</span> <span class="n">net_shell</span><span class="o">.</span><span class="n">img</span>
</pre></div>
</div>
</section>
<section id="alternative-u-boot-boot-commands">
<h3>Alternative U-Boot Boot Commands<a class="headerlink" href="#alternative-u-boot-boot-commands" title="Permalink to this heading"></a></h3>
<p>If you want to boot a “binary” file (like <code class="docutils literal notranslate"><span class="pre">hello.binary</span></code> mentioned
previously) without having to convert it to a <code class="docutils literal notranslate"><span class="pre">u-boot</span></code> image file
(i.e. <code class="docutils literal notranslate"><span class="pre">hello.img</span></code>), you can do this by using <code class="docutils literal notranslate"><span class="pre">go</span></code> to execute the program
instead of <code class="docutils literal notranslate"><span class="pre">bootm</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tftpboot</span> <span class="mh">0x10000000</span> <span class="n">hello</span><span class="o">.</span><span class="n">binary</span>
<span class="n">go</span> <span class="mh">0x10000000</span>
</pre></div>
</div>
<p>You can also go a step further and directly boot the <code class="docutils literal notranslate"><span class="pre">.elf</span></code> file.  The
caveat here is that you must load the <code class="docutils literal notranslate"><span class="pre">.elf</span></code> file into a different,
non-overlapping memory area rather than the program start address that we
have been using up until now:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tftpboot</span> <span class="mh">0x20000000</span> <span class="n">hello</span><span class="o">.</span><span class="n">elf</span>
<span class="n">bootelf</span> <span class="mh">0x20000000</span>
</pre></div>
</div>
<p>This approach applies to both the SD card and TFTP boot methods.</p>
</section>
<section id="using-a-remote-debugger-with-the-microzed-ultrazed">
<h3>Using a Remote Debugger with the MicroZed/UltraZed<a class="headerlink" href="#using-a-remote-debugger-with-the-microzed-ultrazed" title="Permalink to this heading"></a></h3>
<p>If you want to do remote debugging over ethernet, you need to set up
<code class="docutils literal notranslate"><span class="pre">libdebugger</span></code> in your application.  Start with the <code class="docutils literal notranslate"><span class="pre">libbsd</span></code> test
application shown previously and add the following <code class="docutils literal notranslate"><span class="pre">#include</span></code> directives:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;rtems/rtems-debugger.h&gt;</span>
<span class="c1">#include &lt;rtems/rtems-debugger-remote-tcp.h&gt;</span>
</pre></div>
</div>
<p>then add the following static declaration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">rtems_printer</span> <span class="n">printer</span><span class="p">;</span>
</pre></div>
</div>
<p>Now add the following lines before you initialize the shell in
<code class="docutils literal notranslate"><span class="pre">POSIX_Init()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">printf</span> <span class="p">(</span><span class="s2">&quot;registering rtems debugger tcp remote...</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">);</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">rtems_debugger_register_tcp_remote</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">sc</span> <span class="o">!=</span> <span class="n">RTEMS_SUCCESSFUL</span><span class="p">)</span>
    <span class="n">printf</span> <span class="p">(</span><span class="s2">&quot;error in  rtems_debugger_register_tcp_remote()</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>

<span class="n">printf</span> <span class="p">(</span><span class="s2">&quot;starting rtems debugger...</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">);</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">rtems_debugger_start</span><span class="p">(</span><span class="s2">&quot;tcp&quot;</span><span class="p">,</span> <span class="s2">&quot;1222&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">printer</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">sc</span> <span class="o">!=</span> <span class="n">RTEMS_SUCCESSFUL</span><span class="p">)</span>
    <span class="n">printf</span> <span class="p">(</span><span class="s2">&quot;error in  rtems_debugger_start()</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>

<span class="n">rtems_debugger_break</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="o">//</span> <span class="n">Wait</span> <span class="n">here</span> <span class="n">until</span> <span class="n">debugger</span> <span class="n">connects</span>
</pre></div>
</div>
<p>You will also need to link the application with <code class="docutils literal notranslate"><span class="pre">-ldebugger</span></code>.</p>
<p>Now when you boot up the target system with this application, it should wait
for a remote debugger connection before starting the shell.  You should be
able to connect to the target system by executing these commands on your host
development system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">rtems6</span><span class="o">-</span><span class="n">gdb</span> <span class="n">dbg_test</span><span class="o">.</span><span class="n">elf</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">target</span> <span class="n">remote</span> <span class="mf">192.168.1.111</span><span class="p">:</span><span class="mi">1222</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">up</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">up</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">up</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">up</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">up</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">up</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="nb">list</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">quit</span>
</pre></div>
</div>
<p>After quitting the remote debugger, execution should continue on the target
system.</p>
</section>
<section id="debugging-a-qemu-image">
<h3>Debugging a QEMU Image<a class="headerlink" href="#debugging-a-qemu-image" title="Permalink to this heading"></a></h3>
<p>For the Zynq 7000 QEMU target, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">arm</span> <span class="o">-</span><span class="n">serial</span> <span class="n">null</span> <span class="o">-</span><span class="n">serial</span> <span class="n">mon</span><span class="p">:</span><span class="n">stdio</span> <span class="o">-</span><span class="n">net</span> <span class="n">none</span> <span class="o">-</span><span class="n">nographic</span> <span class="o">-</span><span class="n">M</span> <span class="n">xilinx</span><span class="o">-</span><span class="n">zynq</span><span class="o">-</span><span class="n">a9</span> <span class="o">-</span><span class="n">m</span> <span class="mi">256</span><span class="n">M</span> <span class="o">-</span><span class="n">kernel</span> <span class="n">hello</span><span class="o">.</span><span class="n">elf</span> <span class="o">-</span><span class="n">S</span> <span class="o">-</span><span class="n">s</span>
</pre></div>
</div>
<p>This will freeze the CPU on application startup and wait for a debugger to
connect on TCP port <code class="docutils literal notranslate"><span class="pre">1234</span></code>.</p>
<p>Then you can run the following commands on your host development system to
connect to the target system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rsb</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">rtems</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">f0e34ea</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">arm</span><span class="o">-</span><span class="n">rtems6</span><span class="o">-</span><span class="n">gdb</span> <span class="n">hello</span><span class="o">.</span><span class="n">elf</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">target</span> <span class="n">remote</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">1234</span>
</pre></div>
</div>
<p>The process is similar for the ZynqMP QEMU target.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="xenomai-notes.html" class="btn btn-neutral float-left" title="Xenomai" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="git-notes.html" class="btn btn-neutral float-right" title="Git" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, 2019, 2020, 2021, 2022, 2023 Jeffrey A. Webb.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
    /* Sidebar */
    .wy-nav-side {
      /*width:0px;*/
    }
    .wy-side-scroll {
      /*width:0px;*/
    }
    .wy-breadcrumbs {
      visibility: hidden;
    }
    /*
    [role=search] {
    visibility: hidden;
    }
    [role=navigation] {
    visibility: hidden;
    }
    */
    h1 {
    font-size:400%;
    }
  </style>


</body>
</html>